---
title: HTTP1/HTTP2/HTTP3
tag: http
toc: true
---

友联：[浏览器工作原理与实践](https://blog.poetries.top/browser-working-principle/guide/part1/lesson01.html)->浏览器中的网络


### 诞生最早的 HTTP/0.9

网络之间传递 HTML 超文本的内容 （超文本传输协议） 基于请求响应模式 从客户端发出请求，服务器返回数据

完整请求流程：
* 因为 HTTP 都是基于 TCP 协议的，所以客户端先要根据 IP 地址、端口和服务器 建立 TCP 连接，而建立连接的过程就是 TCP 协议 三次握手 的过程
* 建立好连接之后，会发送一个 GET 请求行的信息，如GET /index.html用来获取 index.html。
* 服务器接收请求信息之后，读取对应的 HTML 文件，并将数据以 ASCII 字符流返回给客户端
* HTML 文档传输完成后，断开连接

![http_0.9请求流程](/path/http_0.9请求流程.png)

特点：
 * 只有一个请求行，没有请求头和请求体  请求行就可以完整表达客户端需求
 * 服务器只返回数据  不需要告诉客户端太多信息
 * 文件内容以ASCLL字符流传输    都是html格式文件



### 浏览器推动 HTTP/1.0

不止是html文件传输，还包括 js ，css，img，audio，vedio等等不同类型的文件  支持类文件下载是核心诉求

引入请求头和响应头 以 Key-Value 形式保存  发送请求和返回数据都会带上请求头和响应头信息

 ![http_1请求流程](/path/http_1请求流程.png)

解决问题：
 * 浏览器要知道服务器返回的数据是什么类型的 浏览器才能做针对处理        `accept: text/html` 响应头中内容：`content-type: text/html`
 * 浏览器要知道服务器压缩的方法 单个文件的数据量变大，服务器压缩数据传输   `accept-encoding: gzip, deflate, br`  响应头中内容：`content-encoding: br`
 * 浏览器告诉服务器需要什么语言版本的页面 万维网支持全球范围    `accept-langusge: zh-CN, zh`
 * 浏览器需要知道文件的编码类型   `accept-Charset: ISO-8859-1, utf-8`  响应头中内容：`charest=UTF-8`

新增典型特性：
  * 引入状态码，服务器通过响应行通知浏览器 请求成功或者无法处理或者出错
  * 提供 Cache 机制 缓存已经下载过的数据
  * 请求头中加入了用户代理字段  服务器需要统计客户端基础信息




### 缝缝补补的 HTTP/1.1
  HTTP/1.0典型缺点： 
  * 每次进行http通信，都要经历建立TCP链接，传输HTTP数据和断开TCP链接三个阶段
  * 单个页面中文件越来越多，都经历建立传输断开三个阶段会增加开销
  * 每个域名绑定了唯一的IP地址，一个服务器只支持一个域名。
  * 需要在响应头中设置完整的数据大小，浏览器根据数据大小接收数据。随着发展页面内容动态生成传输之前不知道数据大小浏览器不知道何时接收完数据。

http1.1增加了持久链接的方法： 一个TCP链接上可以传输多个HTTP请求，只要浏览器或者服务器没有明确断开那么TCP会一直保持。
  * 有效减少TCP建立链接和断开链接的次数，减少服务器额外负担，提升整体http请求时长。
  * 默认开启，不需要专门设置请求头信息。
  * 浏览器对于同一个域名默认允许同时建立6个TCP持久链接
  * 虚拟主机支持（使用 CDN 的实现域名分片机制）：请求头中加入了host字段，用来表示当前的域名地址，服务器根据不同的值做不同的处理。随着虚拟主机技术的发展，需要实现在一台物理主机上绑定多个虚拟主机，每个虚拟主机都有自己的单独的域名，这些单独的域名都公用同一个 IP 地址
  * 支持动态内容：引入Chunk transfer机制，服务器将数据分割成若干个任意大小数据块，发送时附带上上个数据块的长度，最后用一个零长度的块作为发送数据完成的标志。
  * 引入客户端cookie机制和安全机制。 (httpOnly)

队头阻塞问题：前面的请求返回之后才能进行下一次请求。如果TCP通道中某个请求因为某些原因没有及时返回就会阻塞后面的所有请求。
断开持久链接：请求头中加上Connection: close;


### 提升网络速度 HTTP/2
HTTP/1.1的缺点：
  对宽带（带宽是指每秒最大能发送或者接收的字节数。我们把每秒能发送的最大字节数称为上行带宽，每秒能够接收的最大字节数称为下行带宽）的利用率不理想：很难用满
  * TCP慢启动：TCP建立成功以后进入发送数据状态，TCP协议会采用一个非常慢的速度发送数据，再慢慢加快，直到速度达到一个理想状态。为了减少网络拥塞的一种策略，没办法改变。页面中不大的资源通过TCP发送耗费时间长。
  * 同时开启多条TCP竞争固定宽带，影响关键资源下载速度。
  * 队头阻塞问题 ---  HTTP/1.1 的机制导致

http/2解决方案：一个域名只使用一个TCP长链接和消除队头阻塞问题。
 ![http_2多路复用](/path/http_2.png)
 多路复用机制：
  * 每个请求都有一个对应的ID。
  * 服务器优先返回缓存好的数据，随意发送，每份数据有其对应id，浏览器接收后 筛选出相同ID的内容拼接出完整的HTTP响应数据。
  * 优先级高的请求优先处理。

多路复用实现：添加了一个二进制分帧层。
  * 浏览器准备好请求行请求头请求数据，post请求方式还需要准备请求体。
  * 二进制分帧层处理之后转换为一个个带有请求ID编号的帧，通过协议栈发送给服务器。
  * 服务器接收后将相同ID的帧合并为一条完整请求信息。
  * 服务器处理请求，并将响应行，响应头，响应体分别发送至二进制分帧层。
  * 二进制分帧层将响应数据转换为一个个带有ID编号的帧，经过协议栈发送给浏览器。
  * 浏览器接收响应帧后根据ID编号将帧的数据提交给对应的请请求。
  * HTTP/2 的语义和 HTTP/1.1 依然是一样的

其他特性：
  * 设置请求优先级：在发送请求时，标上该请求的优先级，这样服务器接收到请求之后，会优先处理优先级高的请求。
  * 服务器推送： 服务器将 已知将要使用的资源和提前推送值浏览器。对首次打开页面的速度起到了至关重要的作用。
  * 头部压缩

大大提升文件传输效率。


### 构建高效网络 HTTP/3
HTTP/2 中所存在的一些问题：
主要包括了 TCP 的队头阻塞、
建立 TCP 连接的延时、
TCP 协议僵化等问题。

优化 TCP 协议存在着诸多挑战，所以官方选择了创建新的 QUIC 协议。

HTTP/3 正是基于 QUIC 协议的
你可以把 QUIC 看成是集成了“TCP+HTTP/2 的多路复用 +TLS 等功能”的一套协议。
这是集众家所长的一个协议，从协议最底层对 Web 的文件传输做了比较彻底的优化，所以等生态相对成熟时，可以用来打造比现在的 HTTP/2 还更加高效的网络。


虽说这套协议解决了 HTTP/2 中因 TCP 而带来的问题，不过由于是改动了底层协议，所以推广起来还会面临着巨大的挑战。


* ～～～
从标准制定到实践再到协议优化还需要走很长一段路；
因为动了底层协议，所以 HTTP/3 的增长会比较缓慢，这和 HTTP/2 有着本质的区别

